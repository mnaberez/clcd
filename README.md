# Commodore LCD Partial Disassembly

This is an incomplete disassembly of the KERNAL ROM of [Bil Herd](http://c128.com/)'s Commodore LCD prototype.  See the [Commodore LCD ROMs](http://mikenaberezny.com/2008/10/04/commodore-lcd-firmware/) page for the original binaries.

This disassembly is based on the [disassembly](https://web.archive.org/web/20170419205827/http://commodore-lcd.lgb.hu/sk/) of the KERNAL ROM found in Bil Herd's LCD prototype published by Gábor Lénárt.  It been changed from a webpage to a source file that can be assembled with [ca65](https://www.cc65.org/doc/ca65.html).  The reassembled binary is bit-identical to the original `kizapr-u102.bin` file.  Some symbols have been renamed to more conventional CBM names, e.g. `LFSDevNum` to `FA`, with the goal of making the disassembly easier to read for those familiar with the other KERNALs.  Some hardcoded addresses were replaced with symbols, e.g. `LAT`.  The original motivation for this version of the disassembly was to better understand the IEC implementation of the LCD.  Therefore, most of the changes from the original are in the IEC routines.

## Findings

### Main Clock

The Commodore LCD probably runs at 1 MHz based on two things:

1. A [photo](https://flickr.com/photos/mnaberez/31314601462) of Bil Herd's prototype shows a 4.0 MHz crystal above the G65SC102.  It is likely that it is connected to pins 35 (XTLI) and 37 (XTLO).  The [GTE 65SC102 datasheet](http://archive.6502.org/datasheets/cmd_g65scxxx_mpu_family.pdf) says, "the 65SC10X Series is supplied with an internal clock generator operating at four times the Φ2 frequency."  The [Rockwell R65C102 datasheet](http://archive.6502.org/datasheets/rockwell_r65c00_microprocessors.pdf) agrees, saying, "The R65C102 internal clocks may be generated by a TTL level single phase input, an RC time base input, (÷ 4) using the XTLO and XTLI input pins.  See Figure 7 for an example of a crystal time base circuit."  Figure 7 reiterates, "R65C102 crystal frequency is divided by 4, i.e. Φ2 (OUT) = F/4."

2. The IEC routine `W1MS` in this KERNAL (at $BE4A) is a busy loop that waits 1 ms.  It is identical to the `W1MS` routine in the C64, a computer which runs at ~1 MHz.  If the LCD ran at a speed other than 1 MHz, `W1MS` would need to be different.

### Serial Bus (IEC)

The IEC routines are extremely similar to those in the C64 KERNAL.  

The IEC signals are connected to VIA1 ($F800):

| Pin | Line | Polarity | Source |
|-----|-----|----------|--------|
|VIA1 PB7 |DAT_IN  |inverted from C64   | DEBPIA $BE3E |
|VIA1 PB6 |CLK_IN  |inverted from C64   | DEBPIA $BE3E |
|VIA1 PB5 |DAT_OUT |same as C64| DATAHI $BE2C, DATALO $BE35 |
|VIA1 PB4 |CLK_OUT |same as C64| CLKHI $BE1A, CLKLO $BE23 |
|VIA1 PB3 |ATN_OUT |same as C64| SCATN $BD4C, LIST5 $BCB8 |

## License

No rights are claimed on the original Commodore LCD ROMs or the initial disassembly work done by Gábor Lénárt.  All other work in this repository is made available under the [3-Clause BSD License](./LICENSE.txt).

## Contact

[Mike Naberezny](https://github.com/mnaberez)
